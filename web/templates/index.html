<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #34495e;
            text-align: center;
        }
        
        .sidebar h3 {
            margin-bottom: 15px;
        }
        
        .user-list {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #34495e;
            cursor: pointer;
        }
        
        .user-item:hover {
            background-color: #34495e;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .username-section {
            display: flex;
            align-items: center;
        }
        
        .username-section input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .username-section button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .username-section button:hover {
            background-color: #2980b9;
        }
        
        /* å†…å®¹åŒº */
        .content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* æ–‡ä»¶åˆ—è¡¨åŒº */
        .file-section {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            padding: 10px 20px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .upload-btn:hover {
            background-color: #27ae60;
        }
        
        .delete-btn {
            padding: 10px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .delete-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        #file-input {
            display: none;
        }
        
        .file-list {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .file-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .file-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .download-btn {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .download-btn:hover {
            background-color: #2980b9;
        }
        
        .delete-file-btn {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .delete-file-btn:hover {
            background-color: #c0392b;
        }
        
        .file-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
        }
        
        /* èŠå¤©åŒº */
        .chat-section {
            width: 300px;
            background-color: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
        }
        
        .message .username {
            font-weight: bold;
            color: #3498db;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .message .content {
            word-wrap: break-word;
        }
        
        .message .content img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .message .timestamp {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: right;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        
        .chat-input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: none;
        }
        
        .chat-input-area button {
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .chat-input-area button:hover {
            background-color: #2980b9;
        }
        
        #image-input {
            display: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .content {
                flex-direction: column;
            }
            
            .chat-section {
                width: 100%;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>åœ¨çº¿ç”¨æˆ·</h3>
            </div>
            <div class="user-list" id="user-list">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶éƒ¨å¯¼èˆª -->
            <div class="header">
                <h2>å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“å·¥å…·</h2>
                <div class="username-section">
                    <input type="text" id="username-input" placeholder="ä¿®æ”¹ç”¨æˆ·å">
                    <button id="update-username-btn">ä¿®æ”¹</button>
                </div>
            </div>
            
            <!-- å†…å®¹åŒº -->
            <div class="content">
                <!-- æ–‡ä»¶åˆ—è¡¨åŒº -->
                <div class="file-section">
                    <div class="file-header">
                        <h3>æ–‡ä»¶åˆ—è¡¨</h3>
                        <div>
                            <button class="upload-btn" onclick="document.getElementById('file-input').click()">ä¸Šä¼ æ–‡ä»¶</button>
                            <button class="delete-btn" id="batch-delete-btn" onclick="batchDeleteFiles()" disabled>æ‰¹é‡åˆ é™¤</button>
                            <input type="file" id="file-input" multiple onchange="uploadFiles()">
                        </div>
                    </div>
                    <div class="file-list" id="file-list">
                        <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- èŠå¤©åŒº -->
                <div class="chat-section">
                    <div class="chat-header">
                        <h3>èŠå¤©</h3>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="sendMessageOnEnter(event)">
                        <button onclick="document.getElementById('image-input').click()">ğŸ“·</button>
                        <input type="file" id="image-input" accept="image/*" onchange="sendImage()">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let currentUser = null;
        
        // åˆå§‹åŒ–
        function init() {
            // è¿æ¥Socket.IOæœåŠ¡å™¨
            socket = io();
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // å‘é€ç™»å½•äº‹ä»¶
            socket.emit('user_login', {
                device_info: navigator.userAgent
            });
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç™»å½•æˆåŠŸ
            socket.on('login_success', function(user) {
                currentUser = user;
                document.getElementById('username-input').value = user.username;
            });
            
            // ç”¨æˆ·åˆ—è¡¨æ›´æ–°
            socket.on('user_list_update', function(data) {
                updateUserList(data.users);
            });
            
            // æ–‡ä»¶åˆ—è¡¨æ›´æ–°
            socket.on('file_list_update', function(data) {
                updateFileList(data.files);
            });
            
            // æ–°æ¶ˆæ¯
            socket.on('new_message', function(message) {
                addMessage(message);
            });
            
            // ç”¨æˆ·åæ›´æ–°
            socket.on('username_updated', function(user) {
                currentUser = user;
                document.getElementById('username-input').value = user.username;
            });
            
            // ä¿®æ”¹ç”¨æˆ·åæŒ‰é’®
            document.getElementById('update-username-btn').addEventListener('click', function() {
                updateUsername();
            });
        }
        
        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        function updateUserList(users) {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            users.forEach(function(user) {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="username">${user.username}</div>
                    <div style="font-size: 12px; color: #bdc3c7;">${user.ip_address}</div>
                `;
                userList.appendChild(userItem);
            });
        }
        
        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
        function updateFileList(files) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            
            files.forEach(function(file) {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <input type="checkbox" class="file-checkbox" data-filename="${file.filename}" onchange="updateBatchDeleteButton()">
                    <div class="file-info">
                        <div class="file-name">${file.filename}</div>
                        <div class="file-meta">
                            ${formatFileSize(file.size)} â€¢ ${file.mtime}
                        </div>
                    </div>
                    <div class="file-actions">
                        <a href="${file.url}" class="download-btn" download>ä¸‹è½½</a>
                        <button class="delete-file-btn" onclick="deleteFile('${file.filename}')">åˆ é™¤</button>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
            
            updateBatchDeleteButton();
        }
        
        // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
        function updateBatchDeleteButton() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            batchDeleteBtn.disabled = checkboxes.length === 0;
        }
        
        // åˆ é™¤å•ä¸ªæ–‡ä»¶
        function deleteFile(filename) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${filename} å—ï¼Ÿ`)) {
                fetch(`/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('æ–‡ä»¶åˆ é™¤æˆåŠŸ:', filename);
                    } else {
                        alert('æ–‡ä»¶åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ–‡ä»¶åˆ é™¤é”™è¯¯:', error);
                    alert('æ–‡ä»¶åˆ é™¤å¤±è´¥');
                });
            }
        }
        
        // æ‰¹é‡åˆ é™¤æ–‡ä»¶
        function batchDeleteFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const filenames = Array.from(checkboxes).map(cb => cb.dataset.filename);
            
            if (filenames.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${filenames.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) {
                fetch('/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filenames: filenames })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('æ‰¹é‡åˆ é™¤æˆåŠŸ:', filenames.length, 'ä¸ªæ–‡ä»¶');
                    } else {
                        alert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡åˆ é™¤é”™è¯¯:', error);
                    alert('æ‰¹é‡åˆ é™¤å¤±è´¥');
                });
            }
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        function uploadFiles() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                
                // å‘é€æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', data.filename);
                    } else {
                        alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
                    alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                });
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            fileInput.value = '';
        }
        
        // ä¿®æ”¹ç”¨æˆ·å
        function updateUsername() {
            const newUsername = document.getElementById('username-input').value.trim();
            if (newUsername && newUsername !== currentUser.username) {
                socket.emit('update_username', {
                    username: newUsername
                });
            }
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (message) {
                socket.emit('send_message', {
                    message: message
                });
                messageInput.value = '';
            }
        }
        
        // å›è½¦é”®å‘é€æ¶ˆæ¯
        function sendMessageOnEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // å‘é€å›¾ç‰‡
        function sendImage() {
            const imageInput = document.getElementById('image-input');
            const file = imageInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    socket.emit('send_message', {
                        message: e.target.result,
                        is_image: true
                    });
                };
                reader.readAsDataURL(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            imageInput.value = '';
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒº
        function addMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            let content = '';
            if (message.is_image) {
                content = `<img src="${message.message}" alt="å›¾ç‰‡æ¶ˆæ¯">`;
            } else {
                content = message.message;
            }
            
            messageDiv.innerHTML = `
                <div class="username">${message.username}</div>
                <div class="content">${content}</div>
                <div class="timestamp">${message.timestamp}</div>
            `;
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>